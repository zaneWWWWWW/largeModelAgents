# Agent æ¡†æ¶é›†æˆæŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬é¡¹ç›®é›†æˆäº†è½»é‡çº§ Agent æ¡†æ¶ï¼Œå°†ç®€å•çš„æœ¬åœ°æ¨¡å‹è°ƒç”¨å‡çº§ä¸ºå…·æœ‰å·¥å…·è°ƒç”¨ã€å¤š LLM åç«¯æ”¯æŒã€å¤šè½®æ¨ç†èƒ½åŠ›çš„æ™ºèƒ½ Agent ç³»ç»Ÿã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ReAct æ¨ç†æ¨¡å¼
- **Thought (æ€è€ƒ)**: Agent åˆ†æç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å·¥å…·
- **Action (è¡ŒåŠ¨)**: è°ƒç”¨ç›¸åº”çš„å·¥å…·è·å–ä¿¡æ¯
- **Observation (è§‚å¯Ÿ)**: åˆ†æå·¥å…·æ‰§è¡Œç»“æœ
- **Answer (å›ç­”)**: åŸºäºè§‚å¯Ÿç»“æœç»™å‡ºæœ€ç»ˆå›å¤

### 2. å¤š LLM åç«¯æ”¯æŒ
- **LocalLlamaProvider**: æœ¬åœ° LLaMA æ¨¡å‹æ¨ç†
- **GeminiApiClient**: Google Gemini API è°ƒç”¨
- **FallbackGeminiProvider**: å¤‡ç”¨ Gemini æä¾›è€…

### 3. å·¥å…·ç³»ç»Ÿ
- **å¿ƒç†è¯„ä¼°å·¥å…·**: åŸºäºå¯¹è¯å†å²è¯„ä¼°ç”¨æˆ·å¿ƒç†çŠ¶æ€
- **è®°å¿†æŸ¥è¯¢å·¥å…·**: æŸ¥è¯¢å’Œæ£€ç´¢å†å²å¯¹è¯å†…å®¹
- **å¯¹è¯è®¡æ•°å·¥å…·**: ç®¡ç†å¯¹è¯è½®æ•°å’Œè¯„ä¼°è§¦å‘
- **æœ¬åœ°èŠå¤©å·¥å…·**: æœ¬åœ°æ¨¡å‹ç›´æ¥å¯¹è¯

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AiChatFragment                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   AgentManager                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                  AgentCore                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ToolRegistry â”‚  â”‚     LLMProvider        â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         â”‚          â”‚  â”‚ LocalLlamaProviderâ”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         â–¼          â”‚  â”‚ GeminiApiClient   â”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ FallbackGemini    â”‚  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   Tools    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         â”‚                      â”‚               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         â–¼                      â–¼               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              ReAct Loop                  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Thought â†’ Action â†’ Observation â†’ Answer â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä»£ç ç»“æ„

```
app/src/main/java/com/example/projectv3/agent/
â”œâ”€â”€ Tool.java                    # å·¥å…·æ¥å£å®šä¹‰
â”œâ”€â”€ AgentConfig.java             # Agenté…ç½®ç±»
â”œâ”€â”€ ToolRegistry.java            # å·¥å…·æ³¨å†Œä¸­å¿ƒ
â”œâ”€â”€ AgentCore.java               # Agentæ ¸å¿ƒæ¨ç†å¼•æ“
â”œâ”€â”€ AgentManager.java            # Agentç®¡ç†å™¨
â”œâ”€â”€ llm/                         # LLMæä¾›è€…
â”‚   â”œâ”€â”€ LLMProvider.java         # LLMæä¾›è€…æ¥å£
â”‚   â”œâ”€â”€ LocalLlamaProvider.java  # æœ¬åœ°LLaMAæä¾›è€…
â”‚   â”œâ”€â”€ GeminiApiClient.java     # Gemini APIå®¢æˆ·ç«¯
â”‚   â””â”€â”€ FallbackGeminiProvider.java # å¤‡ç”¨Geminiæä¾›è€…
â””â”€â”€ tools/                       # å†…ç½®å·¥å…·
    â”œâ”€â”€ PsychologicalAssessmentTool.java  # å¿ƒç†è¯„ä¼°å·¥å…·
    â”œâ”€â”€ MemoryTool.java                   # è®°å¿†æŸ¥è¯¢å·¥å…·
    â”œâ”€â”€ ConversationCounterTool.java      # å¯¹è¯è®¡æ•°å·¥å…·
    â””â”€â”€ LocalChatTool.java                # æœ¬åœ°èŠå¤©å·¥å…·

app/src/main/assets/
â””â”€â”€ agent_prompts.txt            # Agentæç¤ºè¯æ¨¡æ¿
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

åœ¨ `AiChatFragment` ä¸­ï¼ŒAgent å·²è‡ªåŠ¨é›†æˆï¼š

```java
// Agentä¼šåœ¨æ¨¡å‹åŠ è½½åè‡ªåŠ¨åˆå§‹åŒ–
agentManager = new AgentManager(requireContext());
if (chatLlamaApi != null && chatLlamaApi.isModelLoaded()) {
    agentManager.initialize(chatLlamaApi);
}
```

### 2. è‡ªå®šä¹‰é…ç½®

```java
AgentConfig config = AgentConfig.builder()
    .systemPrompt("ä½ çš„è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯")
    .maxIterations(5)              // æœ€å¤§æ¨ç†è¿­ä»£æ¬¡æ•°
    .temperature(0.7f)             // ç”Ÿæˆæ¸©åº¦
    .maxTokens(512)                // æœ€å¤§ç”Ÿæˆtokenæ•°
    .enableToolUse(true)           // å¯ç”¨å·¥å…·ä½¿ç”¨
    .enableMemory(true)            // å¯ç”¨è®°å¿†åŠŸèƒ½
    .build();

agentManager.initialize(llmApi, config);
```

### 3. åˆ‡æ¢ LLM åç«¯

```java
// ä½¿ç”¨æœ¬åœ°LLaMA
LLMProvider localProvider = new LocalLlamaProvider(llamaApi);
agentCore.setLLMProvider(localProvider);

// ä½¿ç”¨Gemini API
LLMProvider geminiProvider = new GeminiApiClient(apiKey);
agentCore.setLLMProvider(geminiProvider);
```

## ğŸ”§ åˆ›å»ºè‡ªå®šä¹‰å·¥å…·

### æ­¥éª¤1: å®ç° Tool æ¥å£

```java
package com.example.projectv3.agent.tools;

import com.example.projectv3.agent.Tool;
import org.json.JSONObject;

public class MyCustomTool implements Tool {
    
    @Override
    public String getName() {
        return "my_custom_tool";
    }
    
    @Override
    public String getDescription() {
        return "è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å·¥å…·ï¼Œç”¨äº...";
    }
    
    @Override
    public String getParametersSchema() {
        return "{\n" +
               "  \"type\": \"object\",\n" +
               "  \"properties\": {\n" +
               "    \"param1\": {\n" +
               "      \"type\": \"string\",\n" +
               "      \"description\": \"å‚æ•°1çš„æè¿°\"\n" +
               "    }\n" +
               "  },\n" +
               "  \"required\": [\"param1\"]\n" +
               "}";
    }
    
    @Override
    public ToolResult execute(JSONObject parameters) {
        try {
            String param1 = parameters.getString("param1");
            String result = doSomething(param1);
            return ToolResult.success(result);
        } catch (Exception e) {
            return ToolResult.error("æ‰§è¡Œå¤±è´¥: " + e.getMessage());
        }
    }
}
```

### æ­¥éª¤2: æ³¨å†Œå·¥å…·

åœ¨ `AgentManager.java` çš„ `registerBuiltInTools()` æ–¹æ³•ä¸­æ³¨å†Œï¼š

```java
private void registerBuiltInTools() {
    // ç°æœ‰å·¥å…·...
    
    // æ³¨å†Œè‡ªå®šä¹‰å·¥å…·
    MyCustomTool customTool = new MyCustomTool();
    agentCore.registerTool(customTool);
}
```

## ğŸ“Š å†…ç½®å·¥å…·è¯´æ˜

### 1. å¿ƒç†è¯„ä¼°å·¥å…· (psychological_assessment)

**åŠŸèƒ½**: åŸºäºå¯¹è¯å†å²è¯„ä¼°ç”¨æˆ·çš„å¿ƒç†çŠ¶æ€

**å‚æ•°**:
```json
{
  "trigger_reason": "è§¦å‘è¯„ä¼°çš„åŸå› "
}
```

**è¿”å›**: åŒ…å«æŠ‘éƒç¨‹åº¦ã€ç„¦è™‘ç¨‹åº¦ã€é£é™©æ ‡è®°å’Œå›°æ‰°åˆ†æ•°çš„è¯„ä¼°æŠ¥å‘Š

### 2. è®°å¿†æŸ¥è¯¢å·¥å…· (memory_query)

**åŠŸèƒ½**: æŸ¥è¯¢å’Œæ£€ç´¢å†å²å¯¹è¯å†…å®¹

**å‚æ•°**:
```json
{
  "query_type": "recent|keyword|summary",
  "keyword": "æœç´¢å…³é”®è¯ï¼ˆå¯é€‰ï¼‰",
  "limit": 10
}
```

**æŸ¥è¯¢ç±»å‹**:
- `recent`: æŸ¥è¯¢æœ€è¿‘çš„å¯¹è¯
- `keyword`: æ ¹æ®å…³é”®è¯æœç´¢
- `summary`: ç”Ÿæˆå¯¹è¯æ‘˜è¦

### 3. å¯¹è¯è®¡æ•°å·¥å…· (conversation_counter)

**åŠŸèƒ½**: æŸ¥è¯¢å’Œç®¡ç†å¯¹è¯è®¡æ•°çŠ¶æ€

**å‚æ•°**:
```json
{
  "action": "query|reset"
}
```

### 4. æœ¬åœ°èŠå¤©å·¥å…· (local_chat)

**åŠŸèƒ½**: ç›´æ¥ä¸æœ¬åœ°æ¨¡å‹è¿›è¡Œå¯¹è¯

**å‚æ•°**:
```json
{
  "message": "ç”¨æˆ·æ¶ˆæ¯å†…å®¹"
}
```

## ğŸ¨ æç¤ºè¯å·¥ç¨‹

### ç³»ç»Ÿæç¤ºè¯ç»“æ„

æç¤ºè¯æ¨¡æ¿ä½äº `app/src/main/assets/agent_prompts.txt`ï¼š

```
1. è§’è‰²å®šä¹‰ - ä½ æ˜¯è°ï¼Œä½ çš„èŒè´£
2. å¯¹è¯é£æ ¼ - è¯­è¨€ç‰¹ç‚¹ï¼Œæ€åº¦è¦æ±‚
3. å·¥å…·ä½¿ç”¨åŸåˆ™ - ä½•æ—¶ä½¿ç”¨ï¼Œå¦‚ä½•ä½¿ç”¨
4. æ³¨æ„äº‹é¡¹ - é™åˆ¶è¯´æ˜ï¼Œå®‰å…¨æç¤º
```

### å·¥å…·è°ƒç”¨æ ¼å¼

Agent è‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹ JSON æ ¼å¼çš„å·¥å…·è°ƒç”¨ï¼š

```json
{
  "tool": "å·¥å…·åç§°",
  "parameters": {
    "å‚æ•°å": "å‚æ•°å€¼"
  }
}
```

## ğŸ” è°ƒè¯•å’Œæ—¥å¿—

### æ—¥å¿—æ ‡ç­¾

ä½¿ç”¨ Android Studio Logcat è¿‡æ»¤ä»¥ä¸‹æ ‡ç­¾ï¼š
- `AgentCore`: Agent æ ¸å¿ƒæ¨ç†æ—¥å¿—
- `AgentManager`: Agent ç®¡ç†æ—¥å¿—
- `ToolRegistry`: å·¥å…·æ³¨å†Œæ—¥å¿—
- `LLMProvider`: LLM æä¾›è€…æ—¥å¿—

### ç¤ºä¾‹æ—¥å¿—

```java
Log.d(TAG, "Agentè¿­ä»£ " + iteration);
Log.d(TAG, "LLMå“åº”: " + response);
Log.d(TAG, "æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨: " + toolName);
Log.d(TAG, "å·¥å…·æ‰§è¡ŒæˆåŠŸ: " + result);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ€§èƒ½è€ƒè™‘
- Agent æ¨ç†ä¼šå¢åŠ å“åº”æ—¶é—´ï¼ˆæ¯æ¬¡å·¥å…·è°ƒç”¨éœ€è¦é¢å¤–çš„ LLM æ¨ç†ï¼‰
- å»ºè®®è®¾ç½®åˆç†çš„ `maxIterations`ï¼ˆé»˜è®¤ 5 æ¬¡ï¼‰
- é¿å…åœ¨å·¥å…·ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

### å·¥å…·è°ƒç”¨é¢‘ç‡
- å¿ƒç†è¯„ä¼°å»ºè®®æ¯ 5-10 è½®å¯¹è¯æœ€å¤š 1 æ¬¡
- è®°å¿†æŸ¥è¯¢æŒ‰éœ€ä½¿ç”¨ï¼Œé¿å…è¿‡äºé¢‘ç¹

### æ¨¡å‹å…¼å®¹æ€§
- æœ¬åœ°æ¨ç†åŸºäº llama.cpp
- å°æ¨¡å‹å¯èƒ½éš¾ä»¥å‡†ç¡®è¯†åˆ«å·¥å…·è°ƒç”¨æ ¼å¼
- å»ºè®®ä½¿ç”¨ 1B+ å‚æ•°çš„æ¨¡å‹ä»¥è·å¾—æ›´å¥½çš„å·¥å…·è°ƒç”¨èƒ½åŠ›

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å‡å°‘æ¨ç†æ¬¡æ•°
```java
AgentConfig config = AgentConfig.builder()
    .maxIterations(3)  // å‡å°‘åˆ°3æ¬¡
    .build();
```

### ä¼˜åŒ–æç¤ºè¯
- ä½¿ç”¨ç®€æ´æ˜äº†çš„å·¥å…·æè¿°
- æä¾›æ¸…æ™°çš„ä½¿ç”¨ç¤ºä¾‹
- é¿å…è¿‡é•¿çš„ç³»ç»Ÿæç¤ºè¯

### ç¼“å­˜æœºåˆ¶
- å·¥å…·ç»“æœå¯ç¼“å­˜é¿å…é‡å¤è°ƒç”¨
- è®°å¿†æŸ¥è¯¢ç»“æœå¯ä¸´æ—¶ç¼“å­˜

---

**ç‰ˆæœ¬**: 2.0.0  
**æœ€åæ›´æ–°**: 2025-12
